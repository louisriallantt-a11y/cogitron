<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cogitron Ω</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1 style="text-align:center; color:#00ff88; margin-bottom:20px;">COGITRON Ω</h1>

        <div id="auth-section">
            <input type="text" id="username" placeholder="Pseudo">
            <input type="password" id="password" placeholder="Mot de passe">
            <button onclick="login()">Connexion</button>
            <button onclick="register()" style="background:#222; margin-top:10px;">S'inscrire</button>
        </div>

        <div id="chat-section" class="hidden">
            <div id="chat-box"></div>
            <div id="status" style="color:#00ff88; font-size:12px; margin-bottom:5px; height:15px;"></div>
            
            <div class="input-area">
                <input type="text" id="user-input" placeholder="Message...">
                <button onclick="sendMessage()">Envoyer</button>
            </div>
            
            <div id="admin-section" class="admin-panel hidden">
                <h3>Panel Admin</h3>
                <div id="user-list"></div>
            </div>
            <br>
            <button onclick="location.reload()" style="color:red; background:none; border:1px solid red;">Déconnexion</button>
        </div>
    </div>

    <script>
        // Envoi avec la touche Entrée
        document.getElementById('user-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        async function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const res = await fetch('/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            });
            const data = await res.json();
            if(res.ok) {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('chat-section').classList.remove('hidden');
                if(data.is_admin) {
                    document.getElementById('admin-section').classList.remove('hidden');
                    loadAdmin();
                }
            } else alert("Erreur de connexion");
        }

        async function register() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            await fetch('/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            });
            alert("Compte créé !");
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const box = document.getElementById('chat-box');
            const status = document.getElementById('status');
            if(!input.value) return;

            const text = input.value;
            box.innerHTML += `<div class="message user-msg">${text}</div>`;
            input.value = "";
            status.innerText = "Cogitron réfléchit...";
            box.scrollTop = box.scrollHeight;

            const res = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: text})
            });
            const data = await res.json();
            status.innerText = "";
            
            const msgDiv = document.createElement('div');
            msgDiv.className = "message ia-msg";
            box.appendChild(msgDiv);
            
            let i = 0;
            const interval = setInterval(() => {
                msgDiv.innerHTML += data.reponse.charAt(i);
                i++;
                box.scrollTop = box.scrollHeight;
                if (i >= data.reponse.length) clearInterval(interval);
            }, 20);
        }

        async function loadAdmin() {
            const res = await fetch('/admin_data');
            const data = await res.json();
            document.getElementById('user-list').innerHTML = data.users.map(u => `<div>• ${u.username} (ID: ${u.id})</div>`).join('');
        }
    </script>
</body>
</html>
