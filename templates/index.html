<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/icon.png">
    <title>Cogitron Î©</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h2 id="title" style="text-align:center; color:var(--neon); margin-bottom:15px;">COGITRON Î©</h2>

        <div id="auth-section">
            <input type="text" id="username" placeholder="Louis Riallant">
            <input type="password" id="password" placeholder="Mot de passe">
            <button onclick="login()" style="width:100%">CONNEXION</button>
            <button onclick="register()" style="width:100%; background:transparent; color:white; border:1px solid #333; margin-top:10px;">S'INSCRIRE</button>
        </div>

        <div id="chat-section" class="hidden">
            <div id="chat-box"></div>
            <div id="typing-status"></div>
            <div class="input-area">
                <input type="text" id="user-input" placeholder="Message Ã  Cogitron...">
                <button onclick="sendMessage()">âž¤</button>
            </div>
            <div id="admin-section" class="admin-panel hidden">
                <strong>ðŸ”§ UNITÃ‰ ADMIN :</strong> <div id="user-list"></div>
            </div>
            <button onclick="location.reload()" style="background:none; color:grey; font-size:10px; margin-top:15px; border:none; width:100%;">DÃ‰CONNEXION</button>
        </div>
    </div>

    <script>
        document.getElementById('user-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

        async function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const res = await fetch('/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            });
            const data = await res.json();
            if(res.ok) {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('chat-section').classList.remove('hidden');
                document.getElementById('title').innerText = "UNITÃ‰ Î© CONNECTÃ‰E";
                if(data.is_admin) {
                    document.getElementById('admin-section').classList.remove('hidden');
                    loadAdmin();
                }
            } else alert("ACCÃˆS REFUSÃ‰");
        }

        async function register() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            await fetch('/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            });
            alert("PROFIL ENREGISTRÃ‰.");
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const box = document.getElementById('chat-box');
            const status = document.getElementById('typing-status');
            if(!input.value) return;

            const val = input.value;
            box.innerHTML += `<div class="message user-msg">${val}</div>`;
            input.value = "";
            box.scrollTop = box.scrollHeight;
            status.innerText = "Analyse en cours...";

            const res = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: val})
            });
            const data = await res.json();
            status.innerText = "";
            
            const iaDiv = document.createElement('div');
            iaDiv.className = "message ia-msg";
            box.appendChild(iaDiv);
            
            let i = 0;
            function type() {
                if(i < data.reponse.length) {
                    iaDiv.innerHTML += data.reponse.charAt(i);
                    i++;
                    box.scrollTop = box.scrollHeight;
                    setTimeout(type, 15);
                }
            }
            type();
        }

        async function loadAdmin() {
            const res = await fetch('/admin_data');
            const data = await res.json();
            document.getElementById('user-list').innerHTML = data.users.map(u => `<div>ID ${u.id}: ${u.username}</div>`).join('');
        }
    </script>
</body>
</html>
