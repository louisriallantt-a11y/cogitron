<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>COGITRON ADMIN OS</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --bg: #0a0a0a; --panel: #141414; --accent: {{ current_user.color if current_user.is_authenticated else '#00ff88' }}; }
        body { margin:0; background:var(--bg); color:white; font-family:'Courier New', monospace; height:100vh; display:flex; }
        #auth-screen { position:fixed; inset:0; background:#000; z-index:1000; display:flex; align-items:center; justify-content:center; }
        .auth-card { background:var(--panel); padding:40px; border:1px solid var(--accent); width:300px; text-align:center; }
        input { width:100%; padding:12px; margin:10px 0; background:#000; border:1px solid #333; color:var(--accent); }
        .sidebar { width:260px; background:var(--panel); border-right:1px solid #222; display:flex; flex-direction:column; padding:15px; }
        .main { flex:1; display:flex; flex-direction:column; }
        .header { padding:15px; border-bottom:1px solid #222; display:flex; justify-content:space-between; align-items:center; }
        #chat-view { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:10px; }
        .msg { padding:12px; border-radius:4px; max-width:85%; }
        .msg-user { background:#222; align-self:flex-end; }
        .msg-ia { background:#1a1a1a; align-self:flex-start; border-left:3px solid var(--accent); }
        .admin-btn { margin-top:20px; padding:10px; background:#300; color:red; border:1px solid red; cursor:pointer; font-size:0.7em; }
    </style>
</head>
<body>

    <div id="auth-screen" style="display: {% if current_user.is_authenticated %}none{% else %}flex{% endif %};">
        <div class="auth-card">
            <h2 style="color:var(--accent)">COGITRON_LOGIN</h2>
            <input type="text" id="u" placeholder="USER_ID">
            <input type="password" id="p" placeholder="PASSWORD">
            <button onclick="auth('login')" style="width:100%; padding:10px; background:var(--accent); border:none; font-weight:bold; cursor:pointer;">CONNECTER</button>
            <p onclick="auth('register')" style="color:#444; cursor:pointer; font-size:0.8em; margin-top:15px;">CR√âER COMPTE</p>
        </div>
    </div>

    <div class="sidebar">
        <div style="color:var(--accent); font-weight:bold; margin-bottom:20px;">üíæ ARCHIVES_M√âMOIRE</div>
        <div id="hist-status" style="font-size:0.7em; color:#555;">Historique actif...</div>
        
        {% if current_user.is_admin %}
        <button class="admin-btn" onclick="voirAdmin()">PANNEAU ADMIN</button>
        {% endif %}
        
        <a href="/logout" style="margin-top:auto; color:#ff4444; text-decoration:none; font-size:0.8em;">[D√âCONNEXION]</a>
    </div>

    <div class="main">
        <div class="header">
            <span style="color:white; font-weight:bold;">‚óè SESSION: {{ current_user.username if current_user.is_authenticated else '' }}</span>
            <span style="color:var(--accent); font-size:0.8em;">SECURE_MODE</span>
        </div>
        <div id="chat-view"></div>
        <div id="typing" style="display:none; padding:10px; color:var(--accent); font-size:0.8em;">Cogitron r√©fl√©chit...</div>
        <div style="padding:20px; display:flex; gap:10px;">
            <input type="text" id="user-in" style="flex:1" placeholder="COMMANDE...">
            <button onclick="envoyer()" style="background:var(--accent); border:none; padding:0 20px; cursor:pointer; font-weight:bold;">EXEC</button>
        </div>
    </div>

    <script>
        async function auth(type) {
            const res = await fetch('/' + type, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u.value, password: p.value})
            });
            if(res.ok) { 
                if(type==='register') alert("Compte cr√©√© !");
                location.reload(); 
            } else alert("Erreur");
        }

        async function envoyer() {
            const val = document.getElementById('user-in').value;
            if(!val) return;
            document.getElementById('user-in').value = "";
            const box = document.getElementById('chat-view');
            box.innerHTML += `<div class="msg msg-user">${val}</div>`;
            document.getElementById('typing').style.display = "block";

            const res = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: val})
            });
            const data = await res.json();
            document.getElementById('typing').style.display = "none";
            box.innerHTML += `<div class="msg msg-ia">${marked.parse(data.reponse)}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        async function voirAdmin() {
            const res = await fetch('/admin_stats');
            const data = await res.json();
            let userList = data.users.map(u => (u.is_admin ? '‚òÖ ' : '‚Ä¢ ') + u.username).join('\n');
            alert(`S√âCURIT√â COGITRON\nTotal Messages: ${data.total_msg}\n\nUtilisateurs:\n${userList}`);
        }

        async function loadHist() {
            const res = await fetch('/get_history');
            const data = await res.json();
            const box = document.getElementById('chat-view');
            box.innerHTML = data.map(m => `<div class="msg msg-${m.role==='user'?'user':'ia'}">${marked.parse(m.content)}</div>`).join('');
            box.scrollTop = box.scrollHeight;
        }

        {% if current_user.is_authenticated %} loadHist(); {% endif %}
        document.getElementById('user-in').onkeypress = (e) => { if(e.key === 'Enter') envoyer(); };
    </script>
</body>
</html>
