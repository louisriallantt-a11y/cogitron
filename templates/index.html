<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Cogitron Omega</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <nav class="top-nav">
        <div class="logo">COGITRON Œ©</div>
        <div class="user-menu">
            {% if current_user.is_authenticated %}
                <span class="user-name" style="color: {{ current_user.color }}">{{ current_user.username }}</span>
                <div class="dropdown">
                    <button class="dropbtn">‚öôÔ∏è Menu</button>
                    <div class="dropdown-content">
                        {% if current_user.is_admin %}
                            <a href="#" onclick="openAdmin()">üî¥ Panel Admin</a>
                        {% endif %}
                        <a href="/logout" style="color: #ff4d4d;">üö™ D√©connexion</a>
                    </div>
                </div>
            {% else %}
                <button onclick="document.getElementById('auth-modal').style.display='flex'">Se connecter</button>
            {% endif %}
        </div>
    </nav>

    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('auth-modal').style.display='none'">&times;</span>
            <h2>Connexion / Inscription</h2>
            <input type="text" id="username" placeholder="Nom d'utilisateur"><br><br>
            <input type="password" id="password" placeholder="Mot de passe"><br><br>
            <button onclick="login()">Se connecter</button>
            <button onclick="register()">S'inscrire</button>
        </div>
    </div>

    <div class="chat-container">
        <div id="chat-box"></div>
        <div class="input-area">
            <input type="text" id="user-input" placeholder="Posez votre question...">
            <button onclick="sendMessage()">Envoyer</button>
        </div>
    </div>

    <script>
        // Fonction s√©curis√©e pour le JSON
        async function fetchJSON(url, options) {
            const res = await fetch(url, options);
            const contentType = res.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                return await res.json();
            } else {
                console.error("Le serveur n'a pas renvoy√© de JSON mais du HTML !");
                alert("Erreur serveur : V√©rifie ta base de donn√©es sur Render.");
                return null;
            }
        }

        async function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const data = await fetchJSON('/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            });
            if(data && data.status === 'success') location.reload();
        }

        async function register() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const data = await fetchJSON('/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            });
            if(data && data.status === 'success') alert("Inscrit ! Connecte-toi.");
        }

        async function sendMessage() {
            let input = document.getElementById('user-input');
            let box = document.getElementById('chat-box');
            if(!input.value) return;
            box.innerHTML += `<div class="message user-msg"><b>Moi:</b> ${input.value}</div>`;
            
            const data = await fetchJSON('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: input.value})
            });
            if(data) {
                box.innerHTML += `<div class="message ia-msg"><b>IA:</b> ${data.reponse}</div>`;
            }
            input.value = "";
        }
    </script>
</body>
</html>
