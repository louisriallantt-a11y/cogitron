<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Cogitron Î©</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h2 style="text-align:center; color:var(--neon); margin-bottom:10px;">COGITRON Î©</h2>

        <div id="auth-section">
            <input type="text" id="username" placeholder="Louis Riallant">
            <input type="password" id="password" placeholder="Mot de passe">
            <button onclick="login()" style="width:100%">Connexion</button>
            <button onclick="register()" style="width:100%; background:transparent; color:white; margin-top:10px;">S'inscrire</button>
        </div>

        <div id="chat-section" class="hidden" style="display:flex; flex-direction:column; height:100%;">
            <div id="chat-box"></div>
            
            <div class="input-area">
                <input type="text" id="user-input" placeholder="Ã‰crire Ã  Cogitron...">
                <button onclick="sendMessage()">âž¤</button>
            </div>

            <div id="admin-section" class="admin-panel hidden">
                <strong>ðŸ”§ Admin :</strong> <div id="user-list"></div>
            </div>
            <button onclick="location.reload()" style="background:none; color:grey; font-size:10px;">Quitter</button>
        </div>
    </div>

    <script>
        // Detection Touche EntrÃ©e
        document.getElementById('user-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        async function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const res = await fetch('/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            });
            const data = await res.json();
            if(res.ok) {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('chat-section').classList.remove('hidden');
                if(data.is_admin) {
                    document.getElementById('admin-section').classList.remove('hidden');
                    loadAdmin();
                }
            } else alert("Erreur d'accÃ¨s.");
        }

        async function register() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const res = await fetch('/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            });
            if(res.ok) alert("Compte prÃªt ! Connecte-toi.");
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const box = document.getElementById('chat-box');
            if(!input.value) return;

            const val = input.value;
            box.innerHTML += `<div class="message user-msg">${val}</div>`;
            input.value = "";
            box.scrollTop = box.scrollHeight;

            const res = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: val})
            });
            const data = await res.json();
            
            // Effet Machine Ã  Ã©crire
            const iaDiv = document.createElement('div');
            iaDiv.className = "message ia-msg";
            box.appendChild(iaDiv);
            let i = 0;
            const speed = 15;
            function type() {
                if(i < data.reponse.length) {
                    iaDiv.innerHTML += data.reponse.charAt(i);
                    i++;
                    box.scrollTop = box.scrollHeight;
                    setTimeout(type, speed);
                }
            }
            type();
        }

        async function loadAdmin() {
            const res = await fetch('/admin_data');
            const data = await res.json();
            document.getElementById('user-list').innerHTML = data.users.map(u => `<div>â€¢ ${u.username}</div>`).join('');
        }
    </script>
</body>
</html>
