<script>
    let currentDisc = "general";

    async function login() {
        const u = document.getElementById('user-name').value.trim();
        if(!u) {
            alert("Merci d'entrer un identifiant.");
            return;
        }
        
        console.log("Tentative de connexion pour :", u);

        try {
            const res = await fetch('/login', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({username: u}) 
            });

            if (res.ok) {
                // CACHER le login et AFFICHER l'app
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                console.log("Connexion r√©ussie !");
                chargerListe();
            } else {
                alert("Erreur lors de la connexion au serveur.");
            }
        } catch (error) {
            console.error("Erreur r√©seau :", error);
            alert("Le serveur ne r√©pond pas.");
        }
    }

    async function envoyer() {
        const i = document.getElementById('user-in');
        if(!i.value.trim()) return;
        const text = i.value;
        i.value = "";

        const box = document.getElementById('chat-view');
        box.innerHTML += `
            <div class="msg-container">
                <div class="label">Utilisateur</div>
                <div class="user-text">${text}</div>
            </div>`;
        
        const res = await fetch('/chat', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({message: text, id_discussion: currentDisc}) 
        });
        const data = await res.json();
        
        box.innerHTML += `
            <div class="msg-container">
                <div class="label" style="color:var(--accent)">Cogitron</div>
                <div class="ia-text">${marked.parse(data.reponse)}</div>
            </div>`;
        
        box.scrollTop = box.scrollHeight;
    }

    async function chargerListe() {
        const res = await fetch('/get_discussions');
        const data = await res.json();
        const l = document.getElementById('liste');
        l.innerHTML = data.discussions.map(d => `
            <div class="chat-item" onclick="selectDisc('${d}')">
                üïí ${d.replace('.json','')}
            </div>`).join('');
    }

    function selectDisc(id) {
        currentDisc = id.replace('.json','');
        document.getElementById('chat-view').innerHTML = `<p style="color:#444; text-align:center;">Archive charg√©e : ${currentDisc}</p>`;
    }

    function nouveauChat() {
        let n = prompt("Nom de la nouvelle archive ?");
        if(n) { 
            currentDisc = n; 
            document.getElementById('chat-view').innerHTML = ""; 
            alert("Nouvelle archive '" + n + "' cr√©√©e.");
        }
    }

    document.getElementById('user-in').onkeypress = (e) => { if(e.key === 'Enter') envoyer(); };
</script>
