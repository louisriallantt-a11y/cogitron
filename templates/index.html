<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Cogitron Œ©</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <nav class="top-nav">
        <div class="logo">COGITRON Œ©</div>
        <div class="user-menu">
            {% if current_user.is_authenticated %}
                <span class="user-name" style="color: {{ current_user.color }}">{{ current_user.username }}</span>
                <div class="dropdown">
                    <button class="dropbtn">‚öôÔ∏è Menu</button>
                    <div class="dropdown-content">
                        {% if current_user.is_admin %}
                            <a href="#" onclick="openAdmin()">üî¥ Panel Admin</a>
                        {% endif %}
                        <a href="/logout" style="color: #ff4d4d;">üö™ D√©connexion</a>
                    </div>
                </div>
            {% else %}
                <button class="dropbtn" onclick="document.getElementById('auth-modal').style.display='flex'">Se connecter</button>
            {% endif %}
        </div>
    </nav>

    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('auth-modal').style.display='none'">&times;</span>
            <h2>Acc√®s Cogitron</h2>
            <input type="text" id="username" placeholder="Pseudo">
            <input type="password" id="password" placeholder="Mot de passe">
            <div style="margin-top: 20px;">
                <button class="btn-admin" onclick="login()">Connexion</button>
                <button class="btn-admin" style="background:#444; color:white;" onclick="register()">Cr√©er compte</button>
            </div>
        </div>
    </div>

    <div class="chat-container">
        <div id="chat-box"></div>
        <div class="input-area" style="display:flex; gap:10px; margin-top:20px;">
            <input type="text" id="user-input" placeholder="Ecris ici...">
            <button class="btn-admin" onclick="sendMessage()">Envoyer</button>
        </div>
    </div>

    <script>
        async function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const res = await fetch('/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            });
            const data = await res.json();
            if(res.ok) location.reload();
            else alert(data.message);
        }

        async function register() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const res = await fetch('/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: u, password: p})
            });
            if(res.ok) alert("Compte cr√©√© ! Connecte-toi.");
            else alert("Pseudo d√©j√† pris.");
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const box = document.getElementById('chat-box');
            if(!input.value) return;
            box.innerHTML += `<div class="message user-msg"><b>Moi:</b> ${input.value}</div>`;
            const text = input.value;
            input.value = "";
            const res = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: text})
            });
            const data = await res.json();
            box.innerHTML += `<div class="message ia-msg"><b>Cogitron:</b> ${data.reponse}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        async function openAdmin() {
            const res = await fetch('/admin_stats');
            const data = await res.json();
            if(data.users) {
                let txt = "LISTE UTILISATEURS :\n";
                data.users.forEach(u => {
                    txt += `ID:${u.id} - ${u.username} ${u.is_banned ? '[BANNI]' : ''}\n`;
                });
                const targetId = prompt(txt + "\nEntrez l'ID pour BANNIR quelqu'un (ou Annuler) :");
                if(targetId) {
                    const confirmBan = await fetch('/ban/' + targetId, {method: 'POST'});
                    if(confirmBan.ok) alert("Utilisateur banni !");
                }
            }
        }
    </script>
</body>
</html>
