// Affiche l'âge et la classe dans la barre latérale
function setupApp() { 
    document.getElementById('auth').style.display = 'none'; 
    const age = parseInt(user.user_metadata.age) || 12;
    let classe = "";
    if (age === 10) classe = "CM2";
    else if (age === 11) classe = "6ème";
    else if (age === 12) classe = "5ème";
    else if (age === 13) classe = "4ème";
    else if (age === 14) classe = "3ème";
    else if (age === 15) classe = "2nde";
    else if (age === 16) classe = "1ère";
    
    document.getElementById('user-info').innerText = `Profil : ${age} ans (${classe})`;
    refreshSidebar(); 
}

// L'IA adapte son langage à ta classe
async function askAI() {
    const input = document.getElementById('user-input'), text = input.value.trim();
    if(!text || !user) return;
    if(!chatId) await startNormalChat();

    addMsg(text, 'user');
    input.value = '';
    await sb.from('messages').insert([{chat_id: chatId, user_id: user.id, role:'user', content: text}]);

    const age = parseInt(user.user_metadata.age) || 12;
    let style = "";

    if(age === 10) {
        style = "Explique comme à un élève de CM2. Utilise des mots simples et des images concrètes.";
    } else if(age >= 11 && age <= 14) {
        const classes = {11:"6ème", 12:"5ème", 13:"4ème", 14:"3ème"};
        style = `Explique comme à un élève de collège en niveau ${classes[age]}. Utilise le programme scolaire français de ce niveau.`;
    } else {
        style = "Explique comme à un lycéen. Utilise un vocabulaire précis, des détails techniques et des concepts approfondis.";
    }

    let systemPrompt = isProfMode ? `Tu es un prof passionné. ${style}` : `Tu es Cogitron, une IA cool. ${style}`;

    try {
        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: {"Authorization": `Bearer ${GROQ_KEY}`, "Content-Type": "application/json"},
            body: JSON.stringify({
                model: "llama-3.3-70b-versatile",
                messages: [{role: "system", content: systemPrompt}, {role: "user", content: text}]
            })
        });
        const d = await res.json();
        const reply = d.choices[0].message.content;
        addMsg(reply, 'bot');
        await sb.from('messages').insert([{chat_id: chatId, user_id: user.id, role:'bot', content: reply}]);
        
        const {data:mCheck} = await sb.from('messages').select('id').eq('chat_id', chatId);
        if(mCheck && mCheck.length < 3 && !isProfMode) updateChatTitle(text);
    } catch(e) { console.error(e); }
}// Affiche l'âge et la classe dans la barre latérale
function setupApp() { 
    document.getElementById('auth').style.display = 'none'; 
    const age = parseInt(user.user_metadata.age) || 12;
    let classe = "";
    if (age === 10) classe = "CM2";
    else if (age === 11) classe = "6ème";
    else if (age === 12) classe = "5ème";
    else if (age === 13) classe = "4ème";
    else if (age === 14) classe = "3ème";
    else if (age === 15) classe = "2nde";
    else if (age === 16) classe = "1ère";
    
    document.getElementById('user-info').innerText = `Profil : ${age} ans (${classe})`;
    refreshSidebar(); 
}

// L'IA adapte son langage à ta classe
async function askAI() {
    const input = document.getElementById('user-input'), text = input.value.trim();
    if(!text || !user) return;
    if(!chatId) await startNormalChat();

    addMsg(text, 'user');
    input.value = '';
    await sb.from('messages').insert([{chat_id: chatId, user_id: user.id, role:'user', content: text}]);

    const age = parseInt(user.user_metadata.age) || 12;
    let style = "";

    if(age === 10) {
        style = "Explique comme à un élève de CM2. Utilise des mots simples et des images concrètes.";
    } else if(age >= 11 && age <= 14) {
        const classes = {11:"6ème", 12:"5ème", 13:"4ème", 14:"3ème"};
        style = `Explique comme à un élève de collège en niveau ${classes[age]}. Utilise le programme scolaire français de ce niveau.`;
    } else {
        style = "Explique comme à un lycéen. Utilise un vocabulaire précis, des détails techniques et des concepts approfondis.";
    }

    let systemPrompt = isProfMode ? `Tu es un prof passionné. ${style}` : `Tu es Cogitron, une IA cool. ${style}`;

    try {
        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: {"Authorization": `Bearer ${GROQ_KEY}`, "Content-Type": "application/json"},
            body: JSON.stringify({
                model: "llama-3.3-70b-versatile",
                messages: [{role: "system", content: systemPrompt}, {role: "user", content: text}]
            })
        });
        const d = await res.json();
        const reply = d.choices[0].message.content;
        addMsg(reply, 'bot');
        await sb.from('messages').insert([{chat_id: chatId, user_id: user.id, role:'bot', content: reply}]);
        
        const {data:mCheck} = await sb.from('messages').select('id').eq('chat_id', chatId);
        if(mCheck && mCheck.length < 3 && !isProfMode) updateChatTitle(text);
    } catch(e) { console.error(e); }
}
